<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Registration page</title>
    <div th:replace="fragments/header :: header(title='Registration')"></div>
</head>
<body>
<form class="container" th:id="registration" action="/" method="POST" enctype="utf8">
    <h1 th:text="#{label.form.title}"></h1>
    <div class="form-group row">
        <label class="col-sm-2 col-form-label" th:text="#{label.user.login}">login</label>
        <input class="col-sm-2 form-control" name="login" value="" required th:minlength="4" th:maxlength="15"/>
        <span class="alert alert-danger m-0 p-0" id="loginError" style="display:none"></span>
    </div>
    <div class="form-group row">
        <label class="col-sm-2 col-form-label" th:text="#{label.user.firstName}">firstNane</label>
        <input class="col-sm-2 form-control" name="firstName" value="" required/>
    </div>
    <div class="form-group row">
        <label class="col-sm-2 col-form-label" th:text="#{label.user.lastName}">lastName</label>
        <input class="col-sm-2 form-control" name="lastName" value="" required/>
    </div>
    <div class="form-group row">
        <label class="col-sm-2 col-form-label" th:text="#{label.user.password}">password</label>
        <input id="password" class="col-sm-2 form-control" type="password" th:minlength="8" name="password" value="" required/>
    </div>
    <div class="form-group row">
        <label class="col-sm-2 col-form-label" th:text="#{label.user.confirmPass}">confirm</label>
        <input id="matchingPassword" class="col-sm-2 form-control" type="password" name="matchingPassword" value="" required/>
        <div class="alert alert-danger m-0 p-0" id="globalError" style="display:none;"></div>
    </div>
    <button class="btn btn-dark" type="submit" th:text="#{label.form.submit}">submit</button>
</form>
<script th:inline="javascript">
    var serverContext = [[@{/}]];

        $(document).ready(function () {
            $('#registration').submit(function (event) {
                register(event);
            });

            $(":password").keyup(function () {
                if ($("#globalError:hidden").length !== 1) {
                    if ($("#password").val() != $("#matchingPassword").val()) {
                        $("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
                    } else {
                        $("#globalError").hide().html("");
                    }
                }
            });
        });

        function register(event) {
            event.preventDefault();
            $(".alert").html("").hide();
            // $(".error-list").html("");
            if ($("#password").val() != $("#matchingPassword").val()) {
                $("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
                return;
            }
            var formData = $('form').serialize();
            $.post(serverContext + "register", formData, function (data) {
                if (data.message == "success") {
                    window.location.href = serverContext + "login";
                }
            })
                .fail(function (data) {
                    if (data.responseJSON && data.responseJSON.error == "LoginAlreadyTakenException") {
                        $("#loginError").show().html(data.responseJSON.message);
                    }
                });
        }
</script>
</body>
</html>